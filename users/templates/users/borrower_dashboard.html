{% extends "users/base.html" %}

{% block title %}차주 대시보드{% endblock %}

{% block content %}
<h1>차주 대시보드</h1>

<!-- 새 신청 작성용 카드 -->
<div style="border:2px dashed #888; padding:16px; margin:12px 0; background:#fafafa;">
    <a href="{% url 'new_submission' %}" style="text-decoration:none; color:inherit; display:block;">
        <h2>+ 새 심의 신청 작성</h2>
        <p>새로운 신청서의 기본정보를 입력하고, 재무파일을 업로드합니다.</p>
        <p style="font-size:12px; color:#666;">
            1) 기본정보 입력 &nbsp;→&nbsp;
            2) 파일 업로드 &nbsp;→&nbsp;
            3) 임시저장 또는 제출
        </p>
    </a>
</div>

<!-- 기존 신청 카드 목록 -->
{% if submissions %}
    <h2>이전에 작성한 신청서</h2>

    {% for submission in submissions %}
        <div style="border:1px solid #ccc; padding:16px; margin:12px 0; border-radius:4px; background:#fff;">
            <!-- 카드 전체를 클릭하면 수정 페이지로 이동 -->
            <a href="{% url 'edit_submission' submission.id %}"
               style="text-decoration:none; color:inherit; display:block;">
                <h3>{{ submission.title }}</h3>
                <p style="margin:4px 0;">
                    상태: <strong>{{ submission.get_status_display }}</strong>
                    &nbsp;|&nbsp;
                    작성일: {{ submission.created_at|date:"Y-m-d H:i" }}
                </p>

                {% if submission.net_income %}
                    <p style="margin:4px 0;">
                        당기순이익: {{ submission.net_income|floatformat:0 }} 원
                    </p>
                {% endif %}

                {% if submission.description %}
                    <p style="margin:4px 0; color:#555;">
                        {{ submission.description|truncatechars:80 }}
                    </p>
                {% endif %}

                <p style="margin:4px 0; font-size:12px; color:#666;">
                    첨부된 파일 수: {{ submission.uploads.count }}
                </p>
            </a>

            <!-- 카드 안에서 바로 파일 교체 -->
            <div style="margin-top:8px;">
                <h4 style="margin-bottom:4px;">파일 목록 및 교체</h4>
                <ul>
                    {% for upload in submission.uploads.all %}
                        <li style="margin-bottom:6px;">
                            <span>{{ upload.original_name }}</span>
                            {% if upload.file %}
                                (<a href="{{ upload.file.url }}">보기</a>)
                            {% endif %}

                            <form
                                action="{% url 'replace_upload_inline' upload.id %}"
                                method="post"
                                enctype="multipart/form-data"
                                style="display:inline-block; margin-left:8px;"
                            >
                                {% csrf_token %}
                                <input type="file" name="file" style="display:inline-block; max-width:200px;">
                                <button type="submit">교체</button>
                            </form>
                        </li>
                    {% empty %}
                        <li>첨부된 파일이 없습니다.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endfor %}
{% else %}
    <p>아직 작성된 신청서가 없습니다. 위의 카드를 눌러 첫 심의 신청을 만들어 보세요.</p>
{% endif %}

{% endblock %}
